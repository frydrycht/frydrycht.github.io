<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Investment details</title>
    
    <style>
        body {
            font-family: "fira_sans", -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        }

        table {
            font-size: 0.9em;
            color: #333;
            border-collapse: collapse;
        }

        tr {
            border-bottom: 0.1em solid #CCC;
        }

        th {
            text-align: left;
        }

        #construction_permits_section table, #environmental_permits_section table {
            width: 100%;
            font-size: 0.85em;
        }

        #construction_permits_section th, #environmental_permits_section th {
            background: #eeeeee;
            width: auto;
            padding-left: 5px;
            padding-right: 5px;
        }

        #construction_permits_section td, #environmental_permits_section td {
            width: auto;
            padding-left: 5px;
            padding-right: 5px;
        }

        div.section_title {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            margin-top: 1em;
            background-color: #eeeeee;
            display: block;
            width: 100%;
        }

        #construction_permits_section {
            margin-top: 1em;
        }

        #environmental_permits_section {
            margin-top: 1em;
        }
    </style>
</head>

<body>

    <table id="investment_table">
        <tr id="name_row">
            <th>Nazwa</th>
            <td id="name"></td>
        </tr>

        <tr id="investor_row">
            <th>Inwestor</th>
            <td id="investor"></td>
        </tr>

        <tr id="description_row">
            <th>Opis</th>
            <td id="description"></td>
        </tr>

        <tr id="website_row">
            <th>Strona www</th>
            <td id="website"></td>
        </tr>

        <tr id="status_row">
            <th>Status</th>
            <td id="status"></td>
        </tr>
    </table>    

    <div id="construction_permits_section">
        <div class="section_title">Pozwolenia na budowę</div>
        <div id="construction_permit"></div>
    </div>

    <div id="environmental_permits_section">
        <div class="section_title">Decyzja środowiskowa</div>
        <div id="environmental_permit"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {

            function getQueryParam(name) {
                return new URLSearchParams(window.location.search).get(name);
            }

            function setOrHide(rowId, cellId, value) {
                const row = document.getElementById(rowId);
                const cell = document.getElementById(cellId);

                if (!value) {
                    row.style.display = "none";
                } else {
                    cell.textContent = value;
                }
            }

            function setLinkOrHide(rowId, cellId, url) {
                const row = document.getElementById(rowId);
                const cell = document.getElementById(cellId);

                if (!url) {
                    row.style.display = "none";
                } else {
                    const a = document.createElement("a");
                    a.href = url;
                    a.textContent = url;
                    a.target = "_blank";
                    cell.appendChild(a);
                }
            }

            const investId = getQueryParam("invest-id");
            if (!investId) {
                alert("Brak parametru invest-id");
                return;
            }

            try {
                const [investmentsRes, pnbRes, envRes] = await Promise.all([
                    fetch("/siekierki/data/investments.json"),
                    fetch("/siekierki/data/pnb-data.json"),
                    fetch("/siekierki/data/env-data.json")
                ]);

                const investments = await investmentsRes.json();
                const pnbData = await pnbRes.json();
                const envData = await envRes.json();

                const investment = investments.find(i => i.invest_id === investId);

                if (!investment) {
                    alert("Nie znaleziono inwestycji");
                    return;
                }

                setOrHide("name_row", "name", investment.name);
                setOrHide("investor_row", "investor", investment.investor);
                setOrHide("description_row", "description", investment.description);
                setLinkOrHide("website_row", "website", investment.website?.trim());
                setOrHide("status_row", "status", investment.status);                

                fillConstructionPermits(
                    "construction_permits_section",
                    "construction_permit",
                    investment.construction_permit,
                    pnbData
                );

                fillEnvironmentalPermits(
                    "environmental_permits_section",
                    "environmental_permit",
                    investment.environmental_permit,
                    envData
                );

            } catch (err) {
                console.error(err);
                alert("Błąd ładowania danych");
            }

            function fillConstructionPermits(rowId, cellId, permitIds, pnbData) {
                const row = document.getElementById(rowId);
                const cell = document.getElementById(cellId);

                if (!permitIds || permitIds.length === 0) {
                    row.style.display = "none";
                    return;
                }

                const matched = pnbData.filter(p =>
                    permitIds.includes(p.id)
                );
                matched.sort((a, b) => b.application_date.localeCompare(a.application_date));

                if (matched.length === 0) {
                    row.style.display = "none";
                    return;
                }

                const table = document.createElement("table");
                table.className = "nested-table";

                table.innerHTML = `
        <tr>
            <th>Wnioskodawca</th>
            <th>Przedmiot inwestycji</th>
            <th>Decyzja</th>
            <th>Data decyzji</th>
            <th>Link</th>
        </tr>
    `;

                matched.forEach(p => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
            <td>${p.applicant || ""}</td>
            <td>${p.project_subject || ""}</td>
            <td>${p.decision || ""}</td>
            <td>${p.decision_date || ""}</td>
            <td>
                ${p.link
                            ? `<a href="https://wyszukiwarka.gunb.gov.pl/${p.link}" target="_blank">Zobacz</a>`
                            : ""}
            </td>
        `;

                    table.appendChild(tr);
                });

                cell.appendChild(table);
            }        

            function fillEnvironmentalPermits(rowId, cellId, permitIds, pnbData) {
                const row = document.getElementById(rowId);
                const cell = document.getElementById(cellId);

                if (!permitIds || permitIds.length === 0) {
                    row.style.display = "none";
                    return;
                }

                const matched = pnbData.filter(p =>
                    permitIds.includes(p.id)
                );                
                matched.sort((a, b) => b.application_date.localeCompare(a.application_date));

                if (matched.length === 0) {
                    row.style.display = "none";
                    return;
                }

                const table = document.createElement("table");
                table.className = "nested-table";

                table.innerHTML = `
        <tr>
            <th>Numer sprawy</th>
            <th>Wnioskodawca</th>
            <th>Przedmiot inwestycji</th>
            <th>Status</th>
            <th>Data decyzji</th>
            <th>Linki</th>
        </tr>
    `;

                matched.forEach(p => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
            <td>${p.project_id || ""}</td>
            <td>${p.applicant || ""}</td>
            <td>${p.project_subject || ""}</td>
            <td>${p.status || ""}</td>
            <td>${p.decision_date || ""}</td>
            <td>
                ${fillEnvironmentalLinks(p.urls)}
            </td>
        `;

                    table.appendChild(tr);
                });

                cell.appendChild(table);
            }

            function fillEnvironmentalLinks(urls) {
                let innerHTML = "";

                if (!urls || !Array.isArray(urls)) {
                    return innerHTML;
                }

                urls.forEach(url => {
                    innerHTML += `<a href="${url.url}" target="_blank">${url.name}</a><br>`;
                });

                return innerHTML;
            }
        });
    </script>

</body>

</html>